- name: Install apt dependencies
  become: true
  ansible.builtin.package:
    state: present
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release

- name: Get DEB architecture
  ansible.builtin.command: dpkg --print-architecture
  register: deb_architecture
  changed_when: false

- name: Get DEB release
  ansible.builtin.command: lsb_release -cs
  register: deb_release
  changed_when: false

- name: Create keyrings directory
  become: true
  ansible.builtin.file:
    path: "{{ key_dir }}"
    state: directory
    mode: "0755"

- name: Install GPG key
  become: true
  ansible.builtin.shell: curl -fsSL {{ key_url }} | gpg --dearmor -o {{ key_path }}
  args:
    creates: "{{ key_path }}"
  tags:
    - skip_ansible_lint

- name: Add source file
  become: true
  ansible.builtin.copy:
    content: >
      deb [arch={{ deb_architecture.stdout }} signed-by={{ key_path }}]
      {{ source_url }}
      {{ distribution | default(deb_release.stdout) }}
      {{ components | join (' ') }}
    dest: "{{ source_path }}"
    owner: root
    group: root
    mode: "0644"

- name: Update Apt Repositories
  become: true
  ansible.builtin.package:
    update_cache: true
  changed_when: false
