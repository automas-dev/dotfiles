#!/bin/bash

usage() {
	echo 'Usage: mkn [--lib|--help] name'
}

# Check if a name is given
if [[ $1 == "--help" ]]; then
	usage
	exit 0
elif [[ $# -gt 1 ]]; then
	if [[ $1 == '--lib' ]]; then
		copytest=true
		name=$2
		mkdir -p $name
		cd $name
	else
		usage
		exit 0
	fi
elif [[ $# -gt 0 ]]; then
	if [[ $1 == "--lib" ]]; then
		copytest=true
		name=$(basename $(pwd))
	else
		copytest=false
		name=$1
		mkdir -p $name
		cd $name
	fi
else
	copytest=false
	name=$(basename $(pwd))
fi

# Check that we are not writing over a project
if [[ -f .mk ]]; then
	echo Project $name already exists!
	exit -1
fi

echo Making new project: $name
echo "1.0" > .mk

copy_template() {
	if [[ $# == 2 ]]; then
		cat ~/.scripts/templates/$1 > $2
		echo $1 copy $2
	else
		cat ~/.scripts/templates/$1 > $1
		echo copy $1
	fi
}

mkdir -p src include
copy_template build

git init

if $copytest; then
	copy_template makefile.test makefile
	copy_template run.test run
	copy_template name.cpp src/name.cpp
	copy_template name.h include/name.h
	mkdir -p tests tests/src tests/include
	copy_template tests/makefile
	copy_template tests/TestsMain.cpp tests/src/TestsMain.cpp
	git submodule add https://github.com/abseil/googletest tests/gtest
else
	copy_template makefile
	copy_template run
	copy_template main.cpp src/main.cpp
fi

chmod +x build run
git add .
git commit -m "First Commit"

if $copytest; then
	cd tests/gtest
	cmake .
	make
fi

